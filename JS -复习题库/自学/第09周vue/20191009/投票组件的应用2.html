<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
	<title>珠峰培训 - 微信：18310612838</title>
	<!-- IMPORT CSS -->
	<link rel="stylesheet" href="./node_modules/bootstrap/dist/css/bootstrap.min.css">
	<style>
		.container {
			box-sizing: border-box;
			margin: 20px auto;
			padding: 10px;
			width: 300px;
			border: 1px solid #AAA;
		}

		.container h3 {
			font-size: 16px;
			font-weight: bold;
			line-height: 40px;
			border-bottom: 1px dashed #AAA;
		}
	</style>
</head>

<body>
	<div id="app">
		<my-vote v-for='item in voteList' :title="item.title"></my-vote>
	</div>

	<!-- TEMPLATE -->
	<template id="MyVoteTemplate">
		<div class="container">
			<h3><span v-text='title'></span>（<span v-text='num'></span>）</h3>
			<vote-content :eventbus='eventBus'></vote-content>
			<!-- 基于自定义事件，把父组件中的某个方法注册到任务队列中 -->
			<vote-button :eventbus='eventBus' @changeparent="changeParent"></vote-button>
		</div>
	</template>

	<template id="VoteContentTemplate">
		<div class="content">
			<p>支持人数：<span v-text='supNum'></span></p>
			<p>反对人数：<span v-text='oppNum'></span></p>
			<p>支持率：<span v-text='ratio'></span></p>
		</div>
	</template>

	<template id="VoteButtonTemplate">
		<div class="footer">
			<button type="button" class="btn btn-primary" @click="handle('support')">支持</button>
			<button type="button" class="btn btn-danger" @click="handle('oppose')">反对</button>
		</div>
	</template>

	<!-- IMPORT JS -->
	<script src="./node_modules/vue/dist/vue.js"></script>
	<script>
		const VoteContent = {
			template: '#VoteContentTemplate',
			props: ['eventbus'],
			data() {
				return {
					supNum: 0,
					oppNum: 0
				}
			},
			computed: {
				ratio() {
					let total = this.supNum + this.oppNum;
					if (total === 0) {
						return '0%';
					}
					return (this.supNum / total * 100).toFixed(2) + '%';
				}
			},
			methods: {
				changeNum(type) {
					type === 'support' ? this.supNum++ : this.oppNum++;
				}
			},
			created() {
				//=>基于$on创建一个自定义事件：把指定的方法放到任务队列中
				this.eventbus.$on('changesupport', this.changeNum);
			}
		};

		const VoteButton = {
			template: '#VoteButtonTemplate',
			props: ['eventbus'],
			data() {
				return {}
			},
			methods: {
				handle(type) {
					//=>通知任务队列中@changeParent这个自定义事件执行：第一个参数是自定义事件类型，后面的参数都是通知方法执行的时候，给方法传递的参数
					this.$emit('changeparent', type);
					//=>通知eventBus任务队列中的changesupport自定义事件执行
					this.eventbus.$emit('changesupport', type);
				}
			}
		};

		const MyVote = {
			template: '#MyVoteTemplate',
			props: ["title"],
			data() {
				return {
					num: 0,
					eventBus: new Vue
				}
			},
			components: {
				VoteContent,
				VoteButton
			},
			methods: {
				changeParent(type) {
					//=>this.$emit通知执行的时候传递的参数信息
					this.num++;
				}
			},
			/* mounted() {
				//=>基于属性传递进来的值，只能获取使用，不能在子组件中修改（修改后会有对应的效果，子组件会重新渲染，但是控制台会报错）
				// this.title = 'AAA';
			} */
		};

		let vm = new Vue({
			el: '#app',
			data: {
				voteList: [{
					id: 1,
					title: '朱春亮很丑！'
				}, {
					id: 2,
					title: '张欢很漂亮！'
				}]
			},
			components: {
				MyVote
			},
			/* mounted() {
				setTimeout(() => {
					this.voteList = this.voteList.map(item => {
						if (item.id === 1) {
							item.title = '朱春亮很丑！嗯！';
						}
						return item;
					});
				}, 1000);
			} */
		})
	</script>
</body>

</html>